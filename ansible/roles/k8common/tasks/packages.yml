---
- name: Download Kubernetes package key
  ansible.builtin.get_url:
    url: "{{ k8common_k8s_url_apt_key }}"
    dest: /tmp/kubernetes-apt-key
    mode: '0644'
  retries: 3
  delay: 5

- name: Convert Kubernetes package key to GPG format
  ansible.builtin.command: gpg --dearmor -o {{ k8common_k8s_gpgpath }} /tmp/kubernetes-apt-key
  args:
    creates: "{{ k8common_k8s_gpgpath }}"

- name: Install Kubernetes repository
  ansible.builtin.apt_repository:
    filename: kubernetes
    repo: "deb [signed-by={{ k8common_k8s_gpgpath }}] {{ k8common_k8s_repository }} /"
  retries: 3
  delay: 5

- name: Remove conflicting packages
  ansible.builtin.apt:
    name: "{{ k8common_conflicting_packages }}"
    state: absent
    update_cache: true
  become: true
  retries: 3
  delay: 5

- name: Install required packages
  ansible.builtin.apt:
    name: "{{ k8common_packages }}"
    state: present
    update_cache: true
  become: true
  retries: 3
  delay: 5

- name: Hold specific packages to prevent upgrade
  ansible.builtin.dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop: "{{ k8common_marked_packages }}"
  become: true
