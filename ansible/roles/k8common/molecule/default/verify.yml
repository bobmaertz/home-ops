---
- name: Verify
  hosts: all
  gather_facts: true
  tasks:
    - name: Verify Kubernetes packages are installed
      ansible.builtin.package:
        name:
          - kubeadm
          - kubectl
          - kubelet
          - apt-transport-https
          - ca-certificates
          - curl
          - socat
        state: present
      check_mode: true
      register: package_check
      failed_when: package_check.changed

    - name: Check if containerd service exists and is running
      ansible.builtin.systemd_service:
        name: containerd
      register: containerd_service
      failed_when: containerd_service.status.LoadState != 'loaded'
      # Note: Checking service exists rather than specific package since
      # geerlingguy.containerd may install containerd.io or containerd

    - name: Verify containerd binary exists
      ansible.builtin.stat:
        path: /usr/bin/containerd
      register: containerd_binary
      failed_when: not containerd_binary.stat.exists

    - name: Verify Kubernetes GPG keyring exists
      ansible.builtin.stat:
        path: /usr/share/keyrings/kubernetes-apt-keyring.gpg
      register: gpg_keyring
      failed_when: not gpg_keyring.stat.exists

    - name: Verify kernel modules configuration exists
      ansible.builtin.stat:
        path: /etc/modules-load.d/containerd.conf
      register: modules_conf
      failed_when: not modules_conf.stat.exists

    - name: Verify sysctl configuration exists
      ansible.builtin.stat:
        path: /etc/sysctl.d/kubernetes.conf
      register: sysctl_conf
      failed_when: not sysctl_conf.stat.exists

    - name: Verify containerd config exists
      ansible.builtin.stat:
        path: /etc/containerd/config.toml
      register: containerd_config
      failed_when: not containerd_config.stat.exists

    - name: Check swap is disabled in fstab
      ansible.builtin.shell: grep -v '^#' /etc/fstab | grep swap || true
      register: swap_check
      changed_when: false
      failed_when: swap_check.stdout != ""

    - name: Verify kubeadm package is on hold
      ansible.builtin.shell: apt-mark showhold | grep kubeadm
      register: kubeadm_hold
      changed_when: false
      failed_when: kubeadm_hold.rc != 0
