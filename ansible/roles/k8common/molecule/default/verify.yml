---
- name: Verify
  hosts: all
  gather_facts: true
  tasks:
    - name: Verify Kubernetes packages are installed
      ansible.builtin.package:
        name:
          - kubeadm
          - kubectl
          - kubelet
          - apt-transport-https
          - ca-certificates
          - curl
          - socat
        state: present
      check_mode: true
      register: package_check
      failed_when: package_check.changed

    - name: Check if containerd service exists and is running
      ansible.builtin.systemd_service:
        name: containerd
      register: containerd_service
      failed_when: containerd_service.status.LoadState != 'loaded'
      # Note: Checking service exists rather than specific package since
      # geerlingguy.containerd may install containerd.io or containerd

    - name: Verify containerd binary exists
      ansible.builtin.stat:
        path: /usr/bin/containerd
      register: containerd_binary
      failed_when: not containerd_binary.stat.exists

    - name: Verify Kubernetes GPG keyring exists
      ansible.builtin.stat:
        path: /usr/share/keyrings/kubernetes-apt-keyring.gpg
      register: gpg_keyring
      failed_when: not gpg_keyring.stat.exists

    - name: Verify kernel modules configuration exists
      ansible.builtin.stat:
        path: /etc/modules-load.d/containerd.conf
      register: modules_conf
      failed_when: not modules_conf.stat.exists

    - name: Verify sysctl configuration exists
      ansible.builtin.stat:
        path: /etc/sysctl.d/kubernetes.conf
      register: sysctl_conf
      failed_when: not sysctl_conf.stat.exists

    - name: Verify containerd config exists
      ansible.builtin.stat:
        path: /etc/containerd/config.toml
      register: containerd_config
      failed_when: not containerd_config.stat.exists

    - name: Check swap is disabled in fstab
      ansible.builtin.shell: grep -v '^#' /etc/fstab | grep swap || true
      register: swap_check
      changed_when: false
      failed_when: swap_check.stdout != ""

    - name: Verify kubeadm package is on hold
      ansible.builtin.shell: apt-mark showhold | grep kubeadm
      register: kubeadm_hold
      changed_when: false
      failed_when: kubeadm_hold.rc != 0

    - name: Verify Kubernetes repository was added
      ansible.builtin.stat:
        path: /etc/apt/sources.list.d/kubernetes.list
      register: k8s_repo
      failed_when: not k8s_repo.stat.exists

    - name: Verify kubectl binary exists
      ansible.builtin.stat:
        path: /usr/bin/kubectl
      register: kubectl_binary
      failed_when: not kubectl_binary.stat.exists

    - name: Verify kubeadm binary exists
      ansible.builtin.stat:
        path: /usr/bin/kubeadm
      register: kubeadm_binary
      failed_when: not kubeadm_binary.stat.exists

    - name: Verify kubelet binary exists
      ansible.builtin.stat:
        path: /usr/bin/kubelet
      register: kubelet_binary
      failed_when: not kubelet_binary.stat.exists

    # Configuration Content Validation
    - name: Verify containerd uses systemd cgroup
      ansible.builtin.shell: grep 'SystemdCgroup = true' /etc/containerd/config.toml
      register: systemd_cgroup
      changed_when: false
      failed_when: systemd_cgroup.rc != 0

    - name: Verify containerd sandbox image version
      ansible.builtin.shell: grep 'sandbox_image.*3.10' /etc/containerd/config.toml
      register: sandbox_image
      changed_when: false
      failed_when: sandbox_image.rc != 0

    - name: Verify overlay module in config
      ansible.builtin.shell: grep '^overlay$' /etc/modules-load.d/containerd.conf
      register: overlay_module
      changed_when: false
      failed_when: overlay_module.rc != 0

    - name: Verify br_netfilter module in config
      ansible.builtin.shell: grep '^br_netfilter$' /etc/modules-load.d/containerd.conf
      register: br_netfilter_module
      changed_when: false
      failed_when: br_netfilter_module.rc != 0

    - name: Verify sysctl net.bridge.bridge-nf-call-iptables
      ansible.builtin.shell: sysctl -n net.bridge.bridge-nf-call-iptables 2>/dev/null || echo "not_set"
      register: bridge_iptables
      changed_when: false
      failed_when: false  # Skip in containers where kernel params can't be set

    - name: Verify sysctl net.ipv4.ip_forward
      ansible.builtin.shell: sysctl -n net.ipv4.ip_forward 2>/dev/null || echo "not_set"
      register: ip_forward
      changed_when: false
      failed_when: false  # Skip in containers where kernel params can't be set

    # Package Hold Verification
    - name: Verify kubectl package is on hold
      ansible.builtin.shell: apt-mark showhold | grep kubectl
      register: kubectl_hold
      changed_when: false
      failed_when: kubectl_hold.rc != 0

    - name: Verify kubelet package is on hold
      ansible.builtin.shell: apt-mark showhold | grep kubelet
      register: kubelet_hold
      changed_when: false
      failed_when: kubelet_hold.rc != 0

    # Repository Content Verification
    - name: Verify Kubernetes repository content
      ansible.builtin.shell: grep 'pkgs.k8s.io/core:/stable:/v1.31/deb' /etc/apt/sources.list.d/kubernetes.list
      register: k8s_repo_content
      changed_when: false
      failed_when: k8s_repo_content.rc != 0
