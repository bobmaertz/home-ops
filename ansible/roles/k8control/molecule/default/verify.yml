---
- name: Verify
  hosts: all
  gather_facts: true
  tasks:
    - name: Verify ubuntu user exists
      ansible.builtin.user:
        name: ubuntu
      check_mode: true
      register: user_check
      failed_when: user_check.changed

    - name: Verify .kube directory exists
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.kube"
      register: kube_dir
      failed_when: not kube_dir.stat.exists or not kube_dir.stat.isdir

    - name: Verify kubeconfig file exists
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.kube/config"
      register: kubeconfig
      failed_when: not kubeconfig.stat.exists

    - name: Verify kubeconfig has correct permissions
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.kube/config"
      register: kubeconfig_perms
      failed_when: kubeconfig_perms.stat.mode != '0600'

    - name: Verify KUBECONFIG export in bashrc
      ansible.builtin.shell: grep "export KUBECONFIG" "{{ ansible_user_dir }}/.bashrc"
      register: bashrc_check
      changed_when: false
      failed_when: bashrc_check.rc != 0

    - name: Verify cluster initialization marker exists
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/cluster_initialized.txt"
      register: cluster_init
      failed_when: not cluster_init.stat.exists

    - name: Verify .kube directory ownership
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.kube"
      register: kube_dir_owner
      failed_when: kube_dir_owner.stat.pw_name != ansible_user_id

    - name: Verify kubeconfig ownership
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.kube/config"
      register: kubeconfig_owner
      failed_when: kubeconfig_owner.stat.pw_name != ansible_user_id

    - name: Verify kubectl command exists
      ansible.builtin.command: which kubectl
      register: kubectl_which
      changed_when: false
      failed_when: kubectl_which.rc != 0

    - name: Verify kubeadm command exists
      ansible.builtin.command: which kubeadm
      register: kubeadm_which
      changed_when: false
      failed_when: kubeadm_which.rc != 0

    # Security & Permissions Validation
    - name: Verify kubeconfig is not world-readable
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.kube/config"
      register: kubeconfig_security
      failed_when: kubeconfig_security.stat.mode | regex_search('[0-9]$') not in ['0', '4']

    - name: Verify .kube directory is not world-accessible
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.kube"
      register: kube_dir_security
      failed_when: kube_dir_security.stat.mode | regex_search('[0-9]$') not in ['0', '1', '4', '5']

    # Binary Version Checks
    - name: Check kubectl version
      ansible.builtin.shell: kubectl version --client --short 2>/dev/null || kubectl version --client
      register: kubectl_ver
      changed_when: false
      failed_when: kubectl_ver.rc != 0

    - name: Check kubeadm version
      ansible.builtin.shell: kubeadm version -o short
      register: kubeadm_ver
      changed_when: false
      failed_when: kubeadm_ver.rc != 0
