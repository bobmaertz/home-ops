---
- name: Verify
  hosts: all
  gather_facts: true
  tasks:
    - name: Verify general packages are installed
      ansible.builtin.package:
        name:
          - vim
          - zsh
          - qemu-guest-agent
          - aide
          - aide-common
          - libpam-pwquality
          - libpam-tmpdir
          - needrestart
          - debsums
          - apt-show-versions
        state: present
      check_mode: true
      register: package_check
      failed_when: package_check.changed

    - name: Verify fail2ban is installed
      ansible.builtin.package:
        name: fail2ban
        state: present
      check_mode: true
      register: fail2ban_check
      failed_when: fail2ban_check.changed

    - name: Verify sendmail is installed
      ansible.builtin.package:
        name: sendmail
        state: present
      check_mode: true
      register: sendmail_check
      failed_when: sendmail_check.changed

    - name: Verify ufw is installed
      ansible.builtin.package:
        name: ufw
        state: present
      check_mode: true
      register: ufw_check
      failed_when: ufw_check.changed

    - name: Check if fail2ban service exists
      ansible.builtin.systemd_service:
        name: fail2ban
      register: fail2ban_service
      failed_when: fail2ban_service.status.LoadState != 'loaded'
      ignore_errors: true

    - name: Verify vim binary exists
      ansible.builtin.stat:
        path: /usr/bin/vim
      register: vim_binary
      failed_when: not vim_binary.stat.exists

    - name: Verify zsh binary exists
      ansible.builtin.stat:
        path: /usr/bin/zsh
      register: zsh_binary
      failed_when: not zsh_binary.stat.exists

    - name: Verify sendmail binary exists
      ansible.builtin.stat:
        path: /usr/sbin/sendmail
      register: sendmail_binary
      failed_when: not sendmail_binary.stat.exists

    - name: Verify fail2ban binary exists
      ansible.builtin.stat:
        path: /usr/bin/fail2ban-client
      register: fail2ban_binary
      failed_when: not fail2ban_binary.stat.exists

    # Security & Permissions Validation
    - name: Verify no world-writable files in /etc
      ansible.builtin.shell: find /etc -type f -perm -002 2>/dev/null | wc -l
      register: world_writable
      changed_when: false
      failed_when: world_writable.stdout != "0"
      ignore_errors: true

    - name: Verify SSH directory permissions if exists
      ansible.builtin.stat:
        path: /root/.ssh
      register: ssh_dir
      failed_when: ssh_dir.stat.exists and ssh_dir.stat.mode != '0700'
      ignore_errors: true

    # UFW Configuration Validation
    - name: Verify UFW default deny incoming
      ansible.builtin.shell: ufw status verbose 2>/dev/null | grep -i "Default.*deny.*incoming" || echo "not_active"
      register: ufw_deny_incoming
      changed_when: false
      ignore_errors: true  # May fail in containers

    - name: Verify UFW SSH rule exists
      ansible.builtin.shell: ufw status 2>/dev/null | grep "OpenSSH.*ALLOW" || echo "not_active"
      register: ufw_ssh_rule
      changed_when: false
      ignore_errors: true  # May fail in containers

    # fail2ban Configuration Validation
    - name: Verify fail2ban jail configuration exists
      ansible.builtin.shell: ls /etc/fail2ban/jail.* 2>/dev/null | head -1
      register: fail2ban_config
      changed_when: false
      failed_when: fail2ban_config.stdout == ""
      ignore_errors: true

    # SSH Hardening Validation
    - name: Verify SSH hardening - PermitRootLogin disabled
      ansible.builtin.shell: grep "^PermitRootLogin no" /etc/ssh/sshd_config
      register: ssh_root_login
      changed_when: false
      failed_when: ssh_root_login.rc != 0
      ignore_errors: true

    - name: Verify SSH hardening - PasswordAuthentication disabled
      ansible.builtin.shell: grep "^PasswordAuthentication no" /etc/ssh/sshd_config
      register: ssh_password_auth
      changed_when: false
      failed_when: ssh_password_auth.rc != 0
      ignore_errors: true

    - name: Verify SSH config permissions
      ansible.builtin.stat:
        path: /etc/ssh/sshd_config
      register: sshd_config_stat
      failed_when: sshd_config_stat.stat.mode != '0600'
      ignore_errors: true

    # Sysctl Hardening Validation
    - name: Verify sysctl hardening file exists
      ansible.builtin.stat:
        path: /etc/sysctl.d/99-security-hardening.conf
      register: sysctl_hardening
      failed_when: not sysctl_hardening.stat.exists
      ignore_errors: true

    - name: Verify IP forwarding is disabled
      ansible.builtin.shell: sysctl net.ipv4.conf.all.send_redirects 2>/dev/null | grep "= 0"
      register: ip_forward
      changed_when: false
      ignore_errors: true

    # Automatic Updates Validation
    - name: Verify unattended-upgrades is installed
      ansible.builtin.package:
        name: unattended-upgrades
        state: present
      check_mode: true
      register: unattended_upgrades_check
      failed_when: unattended_upgrades_check.changed
      ignore_errors: true

    - name: Verify unattended-upgrades configuration exists
      ansible.builtin.stat:
        path: /etc/apt/apt.conf.d/50unattended-upgrades
      register: unattended_config
      failed_when: not unattended_config.stat.exists
      ignore_errors: true

    - name: Verify auto-upgrades configuration exists
      ansible.builtin.stat:
        path: /etc/apt/apt.conf.d/20auto-upgrades
      register: auto_upgrades_config
      failed_when: not auto_upgrades_config.stat.exists
      ignore_errors: true

    # Auditd Validation
    - name: Verify auditd is installed
      ansible.builtin.package:
        name: auditd
        state: present
      check_mode: true
      register: auditd_check
      failed_when: auditd_check.changed
      ignore_errors: true

    - name: Verify auditd rules exist
      ansible.builtin.stat:
        path: /etc/audit/rules.d/hardening.rules
      register: audit_rules
      failed_when: not audit_rules.stat.exists
      ignore_errors: true

    - name: Verify fail2ban jail.local exists
      ansible.builtin.stat:
        path: /etc/fail2ban/jail.local
      register: fail2ban_local
      failed_when: not fail2ban_local.stat.exists
      ignore_errors: true
