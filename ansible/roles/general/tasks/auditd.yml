---
- name: Auditd - Install auditd
  ansible.builtin.apt:
    name:
      - auditd
      - audispd-plugins
    state: present
    update_cache: true
  retries: 3
  delay: 5

- name: Auditd - Configure audit rules for security monitoring
  ansible.builtin.copy:
    dest: /etc/audit/rules.d/hardening.rules
    content: |
      # Delete all existing rules
      -D

      # Buffer Size
      -b 8192

      # Failure Mode (0=silent 1=printk 2=panic)
      -f 1

      # Audit the audit logs
      -w /var/log/audit/ -k auditlog

      # Auditd configuration
      -w /etc/audit/ -p wa -k auditconfig
      -w /etc/libaudit.conf -p wa -k auditconfig
      -w /etc/audisp/ -p wa -k audispconfig

      # Monitor for use of audit management tools
      -w /sbin/auditctl -p x -k audittools
      -w /sbin/auditd -p x -k audittools

      # System startup scripts
      -w /etc/init.d/ -p wa -k init
      -w /etc/systemd/ -p wa -k systemd

      # Library searches
      -w /etc/ld.so.conf -p wa -k libpath

      # Kernel parameters
      -w /etc/sysctl.conf -p wa -k sysctl
      -w /etc/sysctl.d/ -p wa -k sysctl

      # Kernel module loading and unloading
      -w /sbin/insmod -p x -k modules
      -w /sbin/rmmod -p x -k modules
      -w /sbin/modprobe -p x -k modules
      -a always,exit -F arch=b64 -S init_module,delete_module -k modules

      # Modprobe configuration
      -w /etc/modprobe.conf -p wa -k modprobe
      -w /etc/modprobe.d/ -p wa -k modprobe

      # PAM configuration
      -w /etc/pam.d/ -p wa -k pam
      -w /etc/security/limits.conf -p wa -k pam
      -w /etc/security/limits.d/ -p wa -k pam
      -w /etc/security/pam_env.conf -p wa -k pam
      -w /etc/security/namespace.conf -p wa -k pam
      -w /etc/security/namespace.d/ -p wa -k pam
      -w /etc/security/namespace.init -p wa -k pam

      # SSH configuration
      -w /etc/ssh/sshd_config -p wa -k sshd
      -w /etc/ssh/sshd_config.d/ -p wa -k sshd

      # Passwd, group, shadow files
      -w /etc/group -p wa -k identity
      -w /etc/passwd -p wa -k identity
      -w /etc/gshadow -p wa -k identity
      -w /etc/shadow -p wa -k identity
      -w /etc/security/opasswd -p wa -k identity

      # Sudoers file changes
      -w /etc/sudoers -p wa -k sudoers
      -w /etc/sudoers.d/ -p wa -k sudoers

      # Login records
      -w /var/log/faillog -p wa -k logins
      -w /var/log/lastlog -p wa -k logins
      -w /var/log/tallylog -p wa -k logins

      # Session initiation information
      -w /var/run/utmp -p wa -k session
      -w /var/log/wtmp -p wa -k session
      -w /var/log/btmp -p wa -k session

      # Network configuration
      -a always,exit -F arch=b64 -S sethostname,setdomainname -k network_modifications
      -w /etc/hosts -p wa -k network_modifications
      -w /etc/network/ -p wa -k network_modifications
      -w /etc/netplan/ -p wa -k network_modifications

      # Process ID change
      -a always,exit -F arch=b64 -S setuid,setgid,setreuid,setregid -k identity
      -a always,exit -F arch=b64 -S setresuid,setresgid -k identity

      # Discretionary access control permission modification
      -a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
      -a always,exit -F arch=b64 -S chown,fchown,fchownat,lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod
      -a always,exit -F arch=b64 -S setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod

      # Unauthorized access attempts to files
      -a always,exit -F arch=b64 -S open,creat,truncate,ftruncate,openat,open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
      -a always,exit -F arch=b64 -S open,creat,truncate,ftruncate,openat,open_by_handle_at -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access

      # File deletion events by user
      -a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat,rmdir -F auid>=1000 -F auid!=4294967295 -k delete

      # Make the configuration immutable
      -e 2
    owner: root
    group: root
    mode: '0640'
  notify: Restart auditd

- name: Auditd - Ensure auditd is enabled and started
  ansible.builtin.systemd_service:
    name: auditd
    enabled: true
    state: started
