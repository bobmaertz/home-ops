---
- name: Verify
  hosts: all
  gather_facts: true
  tasks:
    - name: Verify ufw is installed
      ansible.builtin.package:
        name: ufw
        state: present
      check_mode: true
      register: ufw_check
      failed_when: ufw_check.changed

    - name: Verify UFW binary exists
      ansible.builtin.stat:
        path: /usr/sbin/ufw
      register: ufw_binary
      failed_when: not ufw_binary.stat.exists

    - name: Check UFW status
      ansible.builtin.command: ufw status
      register: ufw_status
      changed_when: false
      failed_when: false

    - name: Verify UFW rules file exists
      ansible.builtin.stat:
        path: /etc/ufw/user.rules
      register: ufw_rules
      # UFW rules file should exist after configuration

    - name: Verify kubelet is installed (from k8common dependency)
      ansible.builtin.package:
        name: kubelet
        state: present
      check_mode: true
      register: kubelet_check
      failed_when: kubelet_check.changed

    - name: Verify kubelet binary exists
      ansible.builtin.stat:
        path: /usr/bin/kubelet
      register: kubelet_binary
      failed_when: not kubelet_binary.stat.exists

    # UFW Rule Validation
    - name: Verify UFW kubelet API port rule
      ansible.builtin.shell: ufw status 2>/dev/null | grep "10250.*ALLOW" || echo "not_active"
      register: kubelet_port
      changed_when: false
      ignore_errors: true  # May fail in containers

    - name: Verify UFW NodePort range rule
      ansible.builtin.shell: ufw status 2>/dev/null | grep "30000:32767.*ALLOW" || echo "not_active"
      register: nodeport_range
      changed_when: false
      ignore_errors: true  # May fail in containers

    # Binary Version Checks
    - name: Check kubelet version
      ansible.builtin.shell: kubelet --version
      register: kubelet_ver
      changed_when: false
      failed_when: kubelet_ver.rc != 0

    # Security & Permissions
    - name: Verify no world-writable files in /etc/kubernetes if exists
      ansible.builtin.shell: find /etc/kubernetes -type f -perm -002 2>/dev/null | wc -l
      register: k8s_world_writable
      changed_when: false
      ignore_errors: true
